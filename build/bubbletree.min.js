var BubbleTree=function(config,onHover,onUnHover){var me=this;me.version="2.0.2";me.$container=$(config.container);me.config=$.extend({rootPath:"",minRadiusLabels:40,minRadiusAmounts:20,minRadiusHideLabels:0,cutLabelsAt:50},config);me.tooltip=config.tooltipCallback?config.tooltipCallback:function(){};if(config.tooltip)me.tooltip=config.tooltip;me.style=config.bubbleStyles;me.ns=BubbleTree;me.nodesByUrlToken={};me.nodeList=[];me.iconsByUrlToken={};me.globalNodeCounter=0;me.displayObjects=[];me.bubbleScale=1;me.globRotation=0;me.currentYear=config.initYear;me.currentCenter=undefined;me.currentTransition=undefined;me.baseUrl="";me.loadData=function(url){$.ajax({url:url,dataType:"json",success:this.setData.bind(this)})};me.setData=function(data){var me=this;if(!data)data=me.config.data;me.initData(data);me.initPaper();me.initBubbles();me.initTween();me.initHistory()};me.initData=function(root){var me=this;root.level=0;me.preprocessData(root);me.traverse(root,0);me.treeRoot=root};me.preprocessData=function(root){var me=this,maxNodes=me.config.maxNodesPerLevel;if(maxNodes){if(maxNodes<root.children.length){var tmp=me.sortChildren(root.children);tmp.reverse();var keep=[],move=[],moveAmount=0,breakdown;for(var i in root.children){if(i<maxNodes){keep.push(root.children[i])}else{move.push(root.children[i]);moveAmount+=Math.max(0,root.children[i].amount)}}root.children=keep;root.children.push({label:"More",name:"more",amount:moveAmount,children:move,breakdown:breakdown})}}};me.traverse=function(node,index){var c,child,pc,me=this,urlTokenSource,styles=me.config.bubbleStyles;if(!node.children)node.children=[];me.nodeList.push(node);node.famount=me.ns.Utils.formatNumber(node.amount);if(node.parent)node.level=node.parent.level+1;if(me.config.clearColors===true)node.color=false;if(styles){var props=["color","shortLabel","icon"];$.each(props,function(p,prop){if(styles.hasOwnProperty("id")&&styles.id.hasOwnProperty(node.id)&&styles.id[node.id].hasOwnProperty(prop)){node[prop]=styles.id[node.id][prop]}else if(node.hasOwnProperty("name")&&styles.hasOwnProperty("name")&&styles.name.hasOwnProperty(node.name)&&styles.name[node.name].hasOwnProperty(prop)){node[prop]=styles.name[node.name][prop]}else if(node.hasOwnProperty("taxonomy")&&styles.hasOwnProperty(node.taxonomy)&&styles[node.taxonomy].hasOwnProperty(node.name)&&styles[node.taxonomy][node.name].hasOwnProperty(prop)){node[prop]=styles[node.taxonomy][node.name][prop]}})}if(!node.color){if(node.level>0)node.color=node.parent.color;else node.color="#999999"}if(node.children.length<1&&node.color){node.color=vis4color.fromHex(node.color).saturation("*.86").x}if(node.level>0){pc=node.parent.children;if(pc.length>1){node.left=pc[(index-1+pc.length)%pc.length];node.right=pc[(Number(index)+1)%pc.length];if(node.right==node.left)node.right=undefined}}if(node.label!==undefined&&node.label!==""){urlTokenSource=node.label}else if(node.token!==undefined&&node.token!==""){urlTokenSource=node.token}else{urlTokenSource=""+me.globalNodeCounter}me.globalNodeCounter++;node.urlToken=urlTokenSource.toLowerCase().replace(/\W/g,"-");while(me.nodesByUrlToken.hasOwnProperty(node.urlToken)){node.urlToken+="-"}me.nodesByUrlToken[node.urlToken]=node;node.maxChildAmount=0;node.children=me.sortChildren(node.children,true,me.config.sortBy);$.each(node.children,function(c,child){child.parent=node;node.maxChildAmount=Math.max(node.maxChildAmount,child.amount);me.traverse(child,c)});if(node.breakdowns){node.breakdownsByName={};$.each(node.breakdowns,function(c,bd){bd.famount=me.ns.Utils.formatNumber(bd.amount);if(bd.name)node.breakdownsByName[bd.name]=bd})}};me.sortChildren=function(children,alternate,sortBy){var tmp=[],odd=true;if(sortBy=="label"){sortBy=me.compareLabels;alternate=false}else sortBy=me.compareAmounts;children.sort(sortBy);if(alternate){while(children.length>0){tmp.push(odd?children.pop():children.shift());odd=!odd}return tmp}else{return children}};me.compareAmounts=function(a,b){if(a.amount>b.amount)return 1;if(a.amount==b.amount)return 0;return-1};me.compareLabels=function(a,b){if(a.label>b.label)return 1;if(a.label==b.label)return 0;return-1};me.initPaper=function(){var me=this,$c=me.$container,rt=me.treeRoot,w=$c.width(),h=$c.height(),paper=Raphael($c[0],w,h),maxRad=Math.min(w,h)*.5-40,base,Vector=me.ns.Vector,origin=new Vector(w*.5,h*.5);me.width=w;me.height=h;me.paper=paper;base=Math.pow((Math.pow(rt.amount,.6)+Math.pow(rt.maxChildAmount,.6)*2)/maxRad,1.6666666667);me.a2radBase=me.ns.a2radBase=base;me.origin=origin;$(window).resize(me.onResize.bind(me))};me.onResize=function(){var me=this,$c=me.$container,w=$c.width(),h=$c.height(),maxRad=Math.min(w,h)*.5-40,base,rt=me.treeRoot,b,obj;me.paper.setSize(w,h);me.origin.x=w*.5;me.origin.y=h*.5;me.width=w;me.height=h;base=Math.pow((Math.pow(rt.amount,.6)+Math.pow(rt.maxChildAmount,.6)*2)/maxRad,1.6666666667);me.a2radBase=me.ns.a2radBase=base;$.each(me.displayObjects,function(b,obj){if(obj.className=="bubble"){obj.bubbleRad=me.ns.Utils.amount2rad(obj.node.amount)}});if(me.currentCenter){me.changeView(me.currentCenter.urlToken)}};me.initTween=function(){this.tweenTimer=setInterval(this.loop,1e3/120)};me.initBubbles=function(){var me=this,rt=me.treeRoot,i,icons=false,Bubbles=me.ns.Bubbles,bubbleClass;me.bubbleClasses=[];if(!me.config.hasOwnProperty("bubbleType"))me.config.bubbleType=["plain"];if(!$.isArray(me.config.bubbleType))me.config.bubbleType=[me.config.bubbleType];if($.isArray(me.config.bubbleType)){$.each(me.config.bubbleType,function(i){if(me.config.bubbleType[i]=="icon")icons=true;me.bubbleClasses.push(me.getBubbleType(me.config.bubbleType[i]))})}var rootBubble=me.createBubble(rt,me.origin,0,0,rt.color);me.traverseBubbles(rootBubble)};me.getBubbleType=function(id){var me=this,Bubbles=me.ns.Bubbles;switch(id){case"pie":return Bubbles.Pies;case"donut":return Bubbles.Donut;case"multi":return Bubbles.Multi;case"icon":return Bubbles.Icon;default:return Bubbles.Plain}};me.traverseBubbles=function(parentBubble){var me=this,ring,a2rad=me.ns.Utils.amount2rad,i,c,children,childBubble,childRadSum=0,oa=0,da,ca,twopi=Math.PI*2;children=parentBubble.node.children;$.each(children,function(i,c){childRadSum+=a2rad(c.amount)});if(children.length>0){ring=me.createRing(parentBubble.node,parentBubble.pos,0,{stroke:"#888","stroke-dasharray":"-"})}$.each(children,function(i,c){da=a2rad(c.amount)/childRadSum*twopi;ca=oa+da*.5;if(isNaN(ca))vis4.log(oa,da,c.amount,childRadSum,twopi);c.centerAngle=ca;childBubble=me.createBubble(c,parentBubble.pos,0,ca,c.color);oa+=da;me.traverseBubbles(childBubble)})};me.createBubble=function(node,origin,rad,angle,color){var me=this,ns=me.ns,i,b,bubble,classIndex=node.level;if(isNaN(classIndex))classIndex=0;classIndex=Math.min(classIndex,me.bubbleClasses.length-1);bubble=new me.bubbleClasses[classIndex](node,me,origin,rad,angle,color);me.displayObjects.push(bubble);return bubble};me.createRing=function(node,origin,rad,attr){var me=this,ns=me.ns,ring;ring=new ns.Ring(node,me,origin,rad,attr);me.displayObjects.push(ring);return ring};me.changeView=function(token){var me=this,paper=me.paper,maxRad=Math.min(me.width,me.height)*.35,ns=me.ns,utils=ns.Utils,o=me.origin,l1attr={stroke:"#ccc","stroke-dasharray":"- "},l2attr={stroke:"#ccc","stroke-dasharray":". "},a2rad=utils.amount2rad,root=me.treeRoot,nodesByUrlToken=me.nodesByUrlToken,node=nodesByUrlToken.hasOwnProperty(token)?nodesByUrlToken[token]:null,t=new ns.Layout,bubble,tr,i,twopi=Math.PI*2,getBubble=me.getBubble.bind(me),getRing=me.getRing.bind(me),unify=me.unifyAngle;if(node!==null){var parent,grandpa,sibling,c,cn,rad1,rad2,rad,srad,sang,ring,tgtScale,radSum,leftTurn=false,rightTurn=false;for(i in me.displayObjects)me.displayObjects[i].hideFlag=true;if(node==root||node.parent==root&&node.children.length<1){t.$(me).bubbleScale=1;t.$(o).x=me.width*.5;t.$(o).y=me.height*.5;parent=getBubble(root);if(node!=root){parent.childRotation=-node.centerAngle}rad1=a2rad(root.amount)+a2rad(root.maxChildAmount)+20;ring=getRing(root);t.$(ring).rad=rad1;for(i in root.children){cn=root.children[i];bubble=getBubble(cn);t.$(bubble).angle=unify(cn.centerAngle+parent.childRotation);t.$(bubble).rad=rad1}}else{var origNode=node;if(node.children.length<1){node=node.parent}tgtScale=maxRad/(a2rad(node.amount)+a2rad(node.maxChildAmount)*2);t.$(me).bubbleScale=tgtScale;parent=getBubble(node);if(me.currentCenter&&me.currentCenter==node.left)rightTurn=true;else if(me.currentCenter&&me.currentCenter==node.right)leftTurn=true;var sa=me.shortestAngleTo;t.$(parent).angle=sa(parent.angle,0);rad1=(a2rad(node.amount)+a2rad(node.maxChildAmount))*tgtScale+20;ring=getRing(node);t.$(ring).rad=rad1;grandpa=getBubble(node.parent);grandpa.childRotation=-node.centerAngle;var maybeRoot=grandpa;while(maybeRoot&&maybeRoot.node.parent){maybeRoot=getBubble(maybeRoot.node.parent,true);t.$(maybeRoot).rad=0}t.$(grandpa).rad=0;var hw=me.width*.5;rad2=0-Math.max(hw*.8-tgtScale*(a2rad(node.parent.amount)+a2rad(Math.max(node.amount*1.15+node.maxChildAmount*1.15,node.left.amount*.85,node.right.amount*.85))),tgtScale*a2rad(node.parent.amount)*-1+hw*.15)+hw;if(node.left&&node.right){var maxSiblSize=tgtScale*a2rad(Math.max(node.left.amount,node.right.amount))}radSum=rad1+rad2;t.$(o).x=me.width*.5-rad2-(node!=origNode?rad1*.35:0);t.$(o).y=me.height*.5;new vis4.DelayedTask(1500,vis4,vis4.log,o,grandpa.pos);rad2+=me.width*.1;ring=getRing(node.parent);t.$(ring).rad=rad2;t.$(parent).rad=rad2;var ao=0-(node!=origNode?origNode.centerAngle+parent.childRotation:0);for(i in node.children){cn=node.children[i];bubble=getBubble(cn);t.$(bubble).angle=me.shortestAngleTo(bubble.angle,cn.centerAngle+parent.childRotation+ao);t.$(bubble).rad=rad1}var siblCut=me.height*.07;if(node.left){sibling=node.left;srad=a2rad(sibling.amount)*tgtScale;sang=twopi-Math.asin((me.paper.height*.5+srad-siblCut)/rad2);bubble=getBubble(sibling);t.$(bubble).rad=rad2;t.$(bubble).angle=sa(bubble.angle,sang)}if(node.right){sibling=node.right;srad=a2rad(sibling.amount)*tgtScale;sang=Math.asin((me.paper.height*.5+srad-siblCut)/rad2);bubble=getBubble(sibling);t.$(bubble).rad=rad2;t.$(bubble).angle=sa(bubble.angle,sang)}node=origNode}for(i in me.displayObjects){var obj=me.displayObjects[i];if(obj.hideFlag&&obj.visible){t.$(obj).alpha=0;if(obj.className=="bubble"&&obj.node.level>1)t.$(obj).rad=0;t.hide(obj)}else if(!obj.hideFlag){t.$(obj).alpha=1;if(!obj.visible){obj.alpha=0;t.show(obj)}}}tr=new ns.Transitioner($.browser.msie||me.currentCenter==node?0:1e3);tr.changeLayout(t);me.currentTransition=tr;if(!me.currentCenter&&$.isFunction(me.config.firstNodeCallback)){me.config.firstNodeCallback(node)}me.currentCenter=node}else{utils.log("node "+token+" not found")}};me.unifyAngle=function(a){var pi=Math.PI,twopi=pi*2;while(a>=twopi)a-=twopi;while(a<0)a+=twopi;return a};me.shortestAngle=function(f,t){var deg=function(a){return Math.round(a/Math.PI*180)+""};var pi=Math.PI,twopi=pi*2,unify=me.unifyAngle;f=unify(f);t=unify(t);var sa=t-f;if(sa>pi)sa-=twopi;if(sa<-pi)sa+=twopi;return sa};me.shortestAngleTo=function(f,t){return f+me.shortestAngle(f,t)};me.shortestLeftTurn=function(f,t){var sa=me.shortestAngle(f,t);if(sa>0)sa=sa-Math.PI*2;return f+sa};me.shortestRightTurn=function(f,t){var sa=me.shortestAngle(f,t);if(sa<0)sa=Math.PI*2+sa;return f+sa};me.getBubble=function(node,keepHidden){return this.getDisplayObject("bubble",node,keepHidden)};me.getRing=function(node){return this.getDisplayObject("ring",node)};me.getDisplayObject=function(className,node,keepHidden){var me=this,i,o;for(i in me.displayObjects){o=me.displayObjects[i];if(o.className!=className)continue;if(o.node==node){if(!keepHidden)o.hideFlag=false;return o}}vis4.log(className+" not found for node",node)};me.initHistory=function(){$.history.init(me.urlChanged.bind(me),{unescape:",/"})};me.freshUrl="";me.urlChanged=function(hash){var me=this,tr=me.currentTransition;if(!me.freshUrl){if(hash.indexOf("/~/")){me.baseUrl=hash.substr(0,hash.indexOf("/~/"))}}me.freshUrl=hash;if(tr&&tr.running){vis4.log("transition is running at the moment, adding listener");tr.onComplete(me.changeUrl.bind(me))}else{me.changeUrl()}};me.changeUrl=function(){var me=this,parts=me.freshUrl.split("/"),token=parts[parts.length-1],url;if(me.freshUrl==="")me.navigateTo(me.treeRoot);if(me.nodesByUrlToken.hasOwnProperty(token)){url=me.getUrlForNode(me.nodesByUrlToken[token]);if(me.freshUrl!=url){$.history.load(url)}else{me.navigateTo(me.nodesByUrlToken[token],true)}}else{me.navigateTo(me.treeRoot)}};me.navigateTo=function(node,fromUrlChange){var me=this;if(fromUrlChange)me.changeView(node.urlToken);else $.history.load(me.getUrlForNode(node));$(".label, .label2",me.$container).removeClass("current");$(".label2."+node.id,me.$container).addClass("current");$(".label."+node.id,me.$container).addClass("current")};me.getUrlForNode=function(node){var parts=[];parts.push(node.urlToken);while(node.parent){parts.push(node.parent.urlToken);node=node.parent}parts.reverse();return me.baseUrl+"/~/"+parts.join("/")};me.onNodeClick=function(node){if($.isFunction(me.config.nodeClickCallback)){me.config.nodeClickCallback(node)}};me.clean=function(){var me=this,i;$(".label").remove()};this.loop=function(){TWEEN.update()};if(!me.config.hasOwnProperty("data")){throw new Error("no data")}if(typeof me.config.data=="string"){me.loadData()}else{new vis4.DelayedTask(1e3,me,me.setData,me.config.data)}};BubbleTree.Styles={};BubbleTree.Layout=function(){var me=this;me.objects=[];me.props=[];me.toHide=[];me.toShow=[];me.$=function(obj){var me=this,i,o,p;for(i in me.objects){o=me.objects[i];if(o==obj)return me.props[i]}me.objects.push(obj);p={};me.props.push(p);return p};me.show=function(obj){var me=this;me.toShow.push(obj)};me.hide=function(obj){var me=this;me.toHide.push(obj)}};BubbleTree.Line=function(bc,attr,origin,angle,fromRad,toRad){this.bc=bc;this.o=origin;this.angle=angle;this.fromRad=fromRad;this.attr=attr;this.toRad=toRad;this.getXY=function(){this.x1=this.o.x+Math.cos(this.angle)*this.fromRad;this.y1=this.o.y-Math.sin(this.angle)*this.fromRad;this.x2=this.o.x+Math.cos(this.angle)*this.toRad;this.y2=this.o.y-Math.sin(this.angle)*this.toRad};this.init=function(){this.getXY();console.log("foo","M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2,attr);this.path=this.bc.paper.path("M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2).attr(this.attr)};this.draw=function(){this.getXY();this.path.attr({path:"M"+this.x1+" "+this.y1+"L"+this.x2+" "+this.y2})};this.init()};BubbleTree.Loader=function(config){var me=this;me.config=config;me.ns=BubbleTree;me.loadData=function(){var me=this,url=me.config.data;console.log("loading url ",url);$.ajax({url:url,context:me,dataType:"json",success:function(data){this.run(data)}})};me.run=function(data){var me=this;var bubbleChart=new BubbleTree(me.config);bubbleChart.setData(data);me.config.instance=bubbleChart};if(!me.config.hasOwnProperty("data")){}if(typeof me.config.data=="string"){me.loadData()}else{me.run(me.config.data)}};BubbleTree.MouseEventGroup=function(target,members){var me=this;me.target=target;me.members=members;me.click=function(callback){var me=this,members=me.members,i,mem;me.clickCallback=callback;for(i in members){mem=members[i];$(mem).click(me.handleClick.bind(me))}};me.handleClick=function(evt){var me=this;me.clickCallback({target:me.target,origEvent:evt,mouseEventGroup:me})};me.hover=function(callback){var me=this,members=me.members,i,mem;me.hoverCallback=callback;for(i in members){mem=members[i];$(mem).hover(me.handleMemberHover.bind(me),me.handleMemberUnHover.bind(me))}};me.unhover=function(callback){var me=this;me.unhoverCallback=callback};me.wasHovering=false;me.mouseIsOver=false;me.handleMemberHover=function(evt){var me=this;new vis4.DelayedTask(25,me,me.handleMemberHoverDelayed,evt)};me.handleMemberHoverDelayed=function(evt){var me=this;me.mouseIsOver=true;if(!me.wasHovering){me.wasHovering=true;if($.isFunction(me.hoverCallback)){me.hoverCallback({target:me.target,origEvent:evt,mouseEventGroup:me})}}};me.handleMemberUnHover=function(evt){var me=this;me.mouseIsOver=false;new vis4.DelayedTask(40,me,me.handleMemberUnHoverDelayed,evt)};me.handleMemberUnHoverDelayed=function(evt){var me=this;if(!me.mouseIsOver){me.wasHovering=false;if($.isFunction(me.unhoverCallback)){me.unhoverCallback({target:me.target,origEvent:evt,mouseEventGroup:me})}}};me.addMember=function(mem){var me=this;if(me.hoverCallback)$(mem).hover(me.handleMemberHover.bind(me),me.handleMemberUnHover.bind(me));me.members.push(mem)};me.removeMember=function(mem){var me=this,members=me.members,i,tmp=[];if(me.clickCallback)$(mem).unbind("click");if(me.hoverCallback)$(mem).unbind("mouseenter mouseleave");for(i in members){if(members[i]!=mem)tmp.push(members[i])}me.members=tmp}};BubbleTree.Ring=function(node,bc,o,rad,attr){var me=this;me.className="ring";me.rad=rad;me.bc=bc;me.attr=attr;me.origin=o;me.alpha=1;me.visible=false;me.node=node;me.init=function(){};me.draw=function(){var me=this,o=me.origin;if(!me.visible)return;me.circle.attr({cx:o.x,cy:o.y,r:me.rad,"stroke-opacity":me.alpha})};me.hide=function(){var me=this;me.circle.remove();me.visible=false};me.show=function(){var me=this;me.circle=me.bc.paper.circle(o.x,o.y,me.rad).attr(me.attr);me.visible=true;me.circle.toBack()};me.init()};BubbleTree.Transitioner=function(duration){var me=this;me.duration=duration;me.running=false;me.completeCallbacks=[];me.changeLayout=function(layout){var i,o,props,p,me=this;me.running=true;me.layout=layout;for(i in layout.toShow){o=layout.toShow[i];if($.isFunction(o.show))o.show()}for(i in layout.objects){o=layout.objects[i];if(o===undefined||o===null)continue;props=layout.props[i];if(me.duration>0){var tween=new TWEEN.Tween(o),toProps={};for(p in props){toProps[p]=props[p]}tween.to(toProps,me.duration);tween.easing(TWEEN.Easing.Exponential.EaseOut);if($.isFunction(o.draw))tween.onUpdate(o.draw.bind(o));if(i==layout.objects.length-1)tween.onComplete(me._completed.bind(me));tween.start()}else{for(p in props){o[p]=props[p]}if(o&&$.isFunction(o.draw))o.draw()}}if(me.duration===0){for(i in layout.objects){o=layout.objects[i];if(o&&$.isFunction(o.draw))o.draw()}me._completed()}};me.onComplete=function(callback){var me=this;try{if($.isFunction(callback))me.completeCallbacks.push(callback)}catch(e){}};me._completed=function(){var me=this,callbacks=me.completeCallbacks,i,obj;me.running=false;for(i in me.layout.objects){obj=me.layout.objects[i];if(obj&&$.isFunction(obj.draw))obj.draw()}for(i in me.layout.toHide){obj=me.layout.toHide[i];if(obj&&$.isFunction(obj.hide))obj.hide()}for(i in callbacks){callbacks[i]()}}};BubbleTree.Utils={};BubbleTree.Utils.log=function(){try{if(window.hasOwnProperty("console"))console.log.apply(this,arguments)}catch(e){}};BubbleTree.Utils.amount2rad=function(a){return Math.pow(Math.max(0,a)/BubbleTree.a2radBase,.6)};BubbleTree.Utils.formatNumber=function(n){var prefix="";if(n<0){n=n*-1;prefix="-"}if(n>=1e12)return prefix+Math.round(n/1e11)/10+"t";if(n>=1e9)return prefix+Math.round(n/1e8)/10+"b";if(n>=1e6)return prefix+Math.round(n/1e5)/10+"m";if(n>=1e3)return prefix+Math.round(n/100)/10+"k";else return prefix+n};BubbleTree.Vector=function(x,y){var me=this;me.x=x;me.y=y;me.length=function(){var me=this;return Math.sqrt(me.x*me.x+me.y*me.y)};me.normalize=function(len){var me=this,l=me.length();if(!len)len=1;me.x*=len/l;me.y*=len/l};me.clone=function(){var me=this;return new BubbleTree.Vector(me.x,me.y)}};BubbleTree.Bubbles=BubbleTree.Bubbles||{};BubbleTree.Bubbles.Plain=function(node,bubblechart,origin,radius,angle,color){var ns=BubbleTree,utils=ns.Utils,me=this;me.className="bubble";me.node=node;me.paper=bubblechart.paper;me.origin=origin;me.bc=bubblechart;me.rad=radius;me.angle=angle;me.color=color;me.alpha=1;me.visible=false;me.ns=ns;me.pos=ns.Vector(0,0);me.bubbleRad=utils.amount2rad(this.node.amount);me.container=me.bc.$container;me.childRotation=0;me.getXY=function(){var me=this,o=me.origin,a=me.angle,r=me.rad;if(me.pos===undefined)me.pos=new me.ns.Vector(0,0);me.pos.x=o.x+Math.cos(a)*r;me.pos.y=o.y-Math.sin(a)*r};me.init=function(){var me=this;me.getXY();var showIcon=false;if(!me.node.shortLabel)me.node.shortLabel=me.node.label.length>me.bc.config.cutLabelsAt+3?me.node.label.substr(0,me.bc.config.cutLabelsAt)+"...":me.node.label;me.initialized=true};me.onclick=function(e){var me=this;me.bc.onNodeClick(me.node);me.bc.navigateTo(me.node)};me.onhover=function(e){var me=this,c=me.bc.$container[0];e.node=me.node;e.target=me;e.bubblePos={x:me.pos.x,y:me.pos.y};e.mousePos={x:e.origEvent.pageX-c.offsetLeft,y:e.origEvent.pageY-c.offsetTop};e.type="SHOW";me.bc.tooltip(e)};me.onunhover=function(e){var me=this,c=me.bc.$container[0];e.node=me.node;e.type="HIDE";e.target=me;e.bubblePos={x:me.pos.x,y:me.pos.y};e.mousePos={x:e.origEvent.pageX-c.offsetLeft,y:e.origEvent.pageY-c.offsetTop};me.bc.tooltip(e)};me.draw=function(){var me=this,r=Math.max(5,me.bubbleRad*me.bc.bubbleScale),ox=me.pos.x,oy=me.pos.y,devnull=me.getXY(),x=me.pos.x,y=me.pos.y;if(!me.visible)return;me.circle.attr({cx:me.pos.x,cy:me.pos.y,r:r,"fill-opacity":me.alpha});if(me.node.children.length>1)me.dashedBorder.attr({cx:me.pos.x,cy:me.pos.y,r:r-4,"stroke-opacity":me.alpha*.9});else me.dashedBorder.attr({"stroke-opacity":0});me.label.show();me.label.find("*").show();me.label2.show();if(r>=me.bc.config.minRadiusLabels){me.label2.hide()}else if(r>=me.bc.config.minRadiusAmounts){me.label.find(".desc").hide()}else if(r>=me.bc.config.minRadiusHideLabels){me.label.hide()}else{me.label.hide();me.label2.hide()}me.label.css({width:2*r+"px",opacity:me.alpha});me.label.css({left:me.pos.x-r+"px",top:me.pos.y-me.label.height()*.5+"px"});var w=Math.max(70,3*r);me.label2.css({width:w+"px",opacity:me.alpha});me.label2.css({left:x-w*.5+"px",top:y+r+"px"})};me.hide=function(){var me=this,i;me.circle.remove();me.dashedBorder.remove();me.label.remove();me.label2.remove();me.visible=false};me.show=function(){var me=this,i,cx=me.pos.x,cy=me.pos.y,r=Math.max(5,me.bubbleRad*me.bc.bubbleScale);me.circle=me.paper.circle(cx,cy,r).attr({stroke:false,fill:me.color});me.dashedBorder=me.paper.circle(cx,cy,r-3).attr({stroke:"#ffffff","stroke-dasharray":"- "});me.label=$('<div class="label '+me.node.id+'"><div class="amount">'+utils.formatNumber(me.node.amount)+'</div><div class="desc">'+me.node.shortLabel+"</div></div>");me.container.append(me.label);if(me.node.children.length>0){$(me.circle.node).css({cursor:"pointer"});$(me.label).css({cursor:"pointer"})}me.label2=$('<div class="label2 '+me.node.id+'"><span>'+me.node.shortLabel+"</span></div>");me.container.append(me.label2);var list=[me.circle.node,me.label,me.dashedBorder.node];var mgroup=new me.ns.MouseEventGroup(me,list);mgroup.click(me.onclick.bind(me));mgroup.hover(me.onhover.bind(me));mgroup.unhover(me.onunhover.bind(me));me.visible=true};me.addOverlay=function(){var me=this;me.overlay=me.paper.circle(me.circle.attrs.cx,me.circle.attrs.cy,me.circle.attrs.r).attr({stroke:false,fill:"#fff",opacity:0});if(Raphael.svg){me.overlay.node.setAttribute("class",me.node.id)}$(me.overlay.node).css({cursor:"pointer"});$(me.overlay.node).click(me.onclick.bind(me));$(me.label).click(me.onclick.bind(me))};me.init()};BubbleTree.Bubbles=BubbleTree.Bubbles||{};BubbleTree.Bubbles.Donut=function(node,bubblechart,origin,radius,angle,color){var ns=BubbleTree,utils=ns.Utils,me=this;me.className="bubble";me.node=node;me.paper=bubblechart.paper;me.origin=origin;me.bc=bubblechart;me.rad=radius;me.angle=angle;me.color=color;me.alpha=1;me.visible=false;me.ns=ns;me.bubbleRad=utils.amount2rad(this.node.amount);me.childRotation=0;me.getXY=function(){var me=this,o=me.origin,a=me.angle,r=me.rad;me.pos.x=o.x+Math.cos(a)*r;me.pos.y=o.y-Math.sin(a)*r};me.init=function(){var me=this;me.pos=new me.ns.Vector(0,0);me.getXY();var breakdown=[],b,i,val,bd=[],styles=me.bc.config.bubbleStyles;if(!me.node.shortLabel)me.node.shortLabel=me.node.label.length>50?me.node.label.substr(0,30)+"...":me.node.label;me.breakdownOpacities=[.2,.7,.45,.6,.35];me.breakdownColors=[false,false,false,false,false,false,false,false,false,false];for(i in me.node.breakdowns){b=me.node.breakdowns[i];b.famount=utils.formatNumber(b.amount);val=b.amount/me.node.amount;breakdown.push(val);bd.push(b);if(styles&&styles.hasOwnProperty("name")&&styles.name.hasOwnProperty(b.name)&&styles.name[b.name].hasOwnProperty("opacity")){me.breakdownOpacities[bd.length-1]=styles.name[b.name].opacity}if(styles&&styles.hasOwnProperty("name")&&styles.name.hasOwnProperty(b.name)&&styles.name[b.name].hasOwnProperty("color")){me.breakdownColors[bd.length-1]=styles.name[b.name].color;me.breakdownOpacities[bd.length-1]=1}}me.node.breakdowns=bd;me.breakdown=breakdown;var showIcon=false;me.initialized=true};me.onclick=function(e){var me=this;me.bc.navigateTo(me.node)};me.onhover=function(e){var me=this,c=me.bc.$container[0];e.node=me.node;e.target=me;e.bubblePos={x:me.pos.x,y:me.pos.y};e.mousePos={x:e.origEvent.pageX-c.offsetLeft,y:e.origEvent.pageY-c.offsetTop};e.type="SHOW";me.bc.tooltip(e)};me.onunhover=function(e){var me=this,c=me.bc.$container[0];e.node=me.node;e.target=me;e.type="HIDE";e.bubblePos={x:me.pos.x,y:me.pos.y};e.mousePos={x:e.origEvent.pageX-c.offsetLeft,y:e.origEvent.pageY-c.offsetTop};me.bc.tooltip(e)};this.draw=function(){var me=this,r=Math.max(5,me.bubbleRad*me.bc.bubbleScale),ox=me.pos.x,oy=me.pos.y,devnull=me.getXY(),showLabel=r>20,x=me.pos.x,y=me.pos.y;if(!me.visible)return;me.circle.attr({cx:x,cy:y,r:r,"fill-opacity":me.alpha});if(me.node.children.length>1)me.dashedBorder.attr({cx:x,cy:y,r:r*.85,"stroke-opacity":me.alpha*.8});else me.dashedBorder.attr({"stroke-opacity":0});if(me.breakdown.length>1){var i,x0,x1,x2,x3,y0,y1,y2,y3,ir=r*.85,oa=-Math.PI*.5,da;for(i in me.breakdown){da=me.breakdown[i]*Math.PI*2;x0=x+Math.cos(oa)*ir;y0=y+Math.sin(oa)*ir;x1=x+Math.cos(oa+da)*ir;y1=y+Math.sin(oa+da)*ir;x2=x+Math.cos(oa+da)*r;y2=y+Math.sin(oa+da)*r;x3=x+Math.cos(oa)*r;y3=y+Math.sin(oa)*r;oa+=da;var path="M"+x0+" "+y0+" A"+ir+","+ir+" 0 "+(da>Math.PI?"1,1":"0,1")+" "+x1+","+y1+" L"+x2+" "+y2+" A"+r+","+r+" 0 "+(da>Math.PI?"1,0":"0,0")+" "+x3+" "+y3+" Z";me.breakdownArcs[i].attr({path:path,"stroke-opacity":me.alpha*.2,"fill-opacity":me.breakdownOpacities[i]*me.alpha})}}if(!showLabel){me.label.hide();me.label2.show()}else{me.label.show();if(r<40){me.label.find(".desc").hide();me.label2.show()}else{me.label.find(".desc").show();me.label2.hide()}}me.label.css({width:2*r*.9+"px",opacity:me.alpha});me.label.css({left:me.pos.x-r*.9+"px",top:me.pos.y-me.label.height()*.53+"px"});var w=Math.max(80,3*r);me.label2.css({width:w+"px",opacity:me.alpha});me.label2.css({left:x-w*.5+"px",top:y+r+"px"})};this.hide=function(){var me=this,i;me.circle.remove();me.dashedBorder.remove();me.label.remove();me.label2.remove();me.visible=false;for(i in me.breakdownArcs){me.breakdownArcs[i].remove()}};me.show=function(){var me=this,i,r=Math.max(5,me.bubbleRad*me.bc.bubbleScale);me.circle=me.paper.circle(me.pos.x,me.pos.y,r).attr({stroke:false,fill:me.color});if($.isFunction(me.bc.config.initTooltip)){me.bc.config.initTooltip(me.node,me.circle.node)}me.dashedBorder=me.paper.circle(me.pos.x,me.pos.y,r*.85).attr({stroke:"#fff","stroke-opacity":me.alpha*.4,"stroke-dasharray":". ",fill:false});me.label=$('<div class="label '+me.node.id+'"><div class="amount">'+utils.formatNumber(me.node.amount)+'</div><div class="desc">'+me.node.shortLabel+"</div></div>");me.bc.$container.append(me.label);if(me.node.children.length>1){$(me.circle.node).css({cursor:"pointer"});$(me.label).css({cursor:"pointer"})}me.label2=$('<div class="label2 '+me.node.id+'"><span>'+me.node.shortLabel+"</span></div>");me.bc.$container.append(me.label2);var list=[me.circle.node,me.label];if(me.breakdown.length>1){me.breakdownArcs={};for(i in me.breakdown){var col=me.breakdownColors[i]?me.breakdownColors[i]:"#fff",arc=me.paper.path("M 0 0 L 2 2").attr({fill:col,"fill-opacity":Math.random()*.4+.3,stroke:"#fff"});me.breakdownArcs[i]=arc;if($.isFunction(me.bc.config.initTooltip)){me.bc.config.initTooltip(me.node.breakdowns[i],arc.node)}}for(i in me.breakdownArcs){$(me.breakdownArcs[i].node).click(me.onclick.bind(me))}}var mgroup=new me.ns.MouseEventGroup(me,list);mgroup.click(me.onclick.bind(me));mgroup.hover(me.onhover.bind(me));mgroup.unhover(me.onunhover.bind(me));me.visible=true};me.arcHover=function(e){var me=this,c=me.bc.$container[0],i,arcs=me.breakdownArcs,node,bd=me.node.breakdowns;for(i in arcs){if(arcs[i].node==e.target){e.node=bd[i];e.bubblePos={x:me.pos.x,y:me.pos.y};e.mousePos={x:e.pageX-c.offsetLeft,y:e.pageY-c.offsetTop};e.target=me;e.type="SHOW";me.bc.tooltip(e);return}}vis4.log("cant find the breakdown node")};me.arcUnhover=function(e){var me=this,c=me.bc.$container[0],i,arcs=me.breakdownArcs,node,bd=me.node.breakdowns;for(i in arcs){if(arcs[i].node==e.target){e.node=bd[i];e.bubblePos={x:me.pos.x,y:me.pos.y};e.mousePos={x:e.pageX-c.offsetLeft,y:e.pageY-c.offsetTop};e.type="HIDE";e.target=me;me.bc.tooltip(e);return}}vis4.log("cant find the breakdown node")};me.init()};BubbleTree.Bubbles=BubbleTree.Bubbles||{};BubbleTree.Bubbles.Icon=function(node,bubblechart,origin,radius,angle,color){var ns=BubbleTree,utils=ns.Utils,me=this;me.className="bubble";me.node=node;me.paper=bubblechart.paper;me.origin=origin;me.bc=bubblechart;me.rad=radius;me.angle=angle;me.color=color;me.alpha=1;me.visible=false;me.ns=ns;me.pos=ns.Vector(0,0);me.bubbleRad=utils.amount2rad(this.node.amount);me.iconLoaded=false;me.childRotation=0;me.getXY=function(){var me=this,o=me.origin,a=me.angle,r=me.rad;if(me.pos===undefined)me.pos=new me.ns.Vector(0,0);me.pos.x=o.x+Math.cos(a)*r;me.pos.y=o.y-Math.sin(a)*r};me.init=function(){var me=this;me.getXY();me.hasIcon=me.node.hasOwnProperty("icon");if(!me.node.shortLabel)me.node.shortLabel=me.node.label.length>50?me.node.label.substr(0,30)+"...":me.node.label;me.initialized=true};me.show=function(){var me=this,i,cx=me.pos.x,icon,cy=me.pos.y,r=Math.max(5,me.bubbleRad*me.bc.bubbleScale);me.circle=me.paper.circle(cx,cy,r).attr({stroke:false,fill:me.color});me.dashedBorder=me.paper.circle(cx,cy,Math.min(r-3,r*.95)).attr({stroke:"#ffffff","stroke-dasharray":"- "});if($.isFunction(me.bc.config.initTooltip)){me.bc.config.initTooltip(me.node,me.circle.node)}me.label=$('<div class="label '+me.node.id+'"><div class="amount">'+utils.formatNumber(me.node.amount)+'</div><div class="desc">'+me.node.shortLabel+"</div></div>");me.bc.$container.append(me.label);if($.isFunction(me.bc.config.initTooltip)){me.bc.config.initTooltip(me.node,me.label[0])}me.label2=$('<div class="label2 '+me.node.id+'"><span>'+me.node.shortLabel+"</span></div>");me.bc.$container.append(me.label2);if(me.node.children.length>0){$(me.circle.node).css({cursor:"pointer"});$(me.label).css({cursor:"pointer"})}me.visible=true;if(me.hasIcon){if(!me.iconLoaded)me.loadIcon();else me.displayIcon()}else{me.addOverlay()}};me.loadIcon=function(){var me=this,ldr=new vis4loader;ldr.add(me.bc.config.rootPath+me.node.icon);ldr.load(me.iconLoadComplete.bind(me))};me.iconLoadComplete=function(ldr){var me=this,svg,j,paths;svg=ldr.items[0].data;me.iconPathData="";svg=$(svg);paths=$("path",svg);for(j in paths){if(paths[j]&&$.isFunction(paths[j].getAttribute)){me.iconPathData+=String(paths[j].getAttribute("d"))+" "}}me.iconLoaded=true;me.displayIcon()};me.displayIcon=function(){var me=this,i,path;me.iconPaths=[];path=me.paper.path(me.iconPathData);path.attr({fill:"#fff",stroke:"none"}).translate(-50,-50);me.iconPaths.push(path);me.addOverlay()};me.addOverlay=function(){var me=this;me.overlay=me.paper.circle(me.circle.attrs.cx,me.circle.attrs.cy,me.circle.attrs.r).attr({stroke:false,fill:"#fff","fill-opacity":0});if(Raphael.svg){me.overlay.node.setAttribute("class",me.node.id)}$(me.overlay.node).css({cursor:"pointer"});$(me.overlay.node).click(me.onclick.bind(me));$(me.label).click(me.onclick.bind(me));$(me.label2).click(me.onclick.bind(me));if($.isPlainObject(me.bc.tooltip)){var tt=me.bc.tooltip.content(me.node);$(me.overlay.node).qtip({position:{target:"mouse",viewport:$(window),adjust:{x:7,y:7}},show:{delay:me.bc.tooltip.delay||100},content:{title:tt[0],text:tt[1]}})
}};me.removeIcon=function(){var me=this,i,path;for(i in me.iconPaths){me.iconPaths[i].remove()}me.iconPaths=[]};me.draw=function(){var me=this,r=Math.max(5,me.bubbleRad*me.bc.bubbleScale),ox=me.pos.x,oy=me.pos.y,devnull=me.getXY(),x=me.pos.x,y=me.pos.y,showIcon=me.hasIcon&&r>15,showLabel=me.hasIcon?r>40:r>20,i,path,scale,transform,ly;if(!me.visible)return;me.circle.attr({cx:x,cy:y,r:r,"fill-opacity":me.alpha});if(me.overlay)me.overlay.attr({cx:x,cy:y,r:Math.max(10,r)});if(me.node.children.length>1)me.dashedBorder.attr({cx:me.pos.x,cy:me.pos.y,r:Math.min(r-3,r-4),"stroke-opacity":me.alpha*.9});else me.dashedBorder.attr({"stroke-opacity":0});if(!showLabel){me.label.hide();me.label2.show()}else{me.label.show();if(showIcon&&r<70||!showIcon&&r<40){me.label.find(".desc").hide();me.label2.show()}else{me.label.find(".desc").show();me.label2.hide()}}ly=showIcon?y+r*.77-me.label.height():y-me.label.height()*.5;me.label.css({width:(showIcon?r*1.2:2*r)+"px",opacity:me.alpha});me.label.css({left:(showIcon?x-r*.6:x-r)+"px",top:ly+"px"});var w=Math.max(80,3*r);me.label2.css({width:w+"px",opacity:me.alpha});me.label2.css({left:x-w*.5+"px",top:y+r+"px"});if(me.hasIcon){if(showIcon){scale=(r-(showLabel?me.label.height()*.5:0))/60;for(i in me.iconPaths){path=me.iconPaths[i];if(Raphael.version[0]=="1"){transform="scale("+scale+") translate("+x/scale+", "+(y+(showLabel?me.label.height()*-.5:0))/scale+")"}else{transform="scale("+scale+") translate("+(x/scale-50)+", "+((y+(showLabel?me.label.height()*-.5:0))/scale-50)+")"}path.node.setAttribute("transform",transform);path.attr({"fill-opacity":me.alpha})}}else{for(i in me.iconPaths){path=me.iconPaths[i];path.attr({"fill-opacity":0})}}}};me.hide=function(){var me=this,i;me.circle.remove();me.dashedBorder.remove();me.label.remove();me.label2.remove();me.visible=false;if(me.hasIcon)me.removeIcon();if(me.overlay)me.overlay.remove()};me.onclick=function(e){var me=this;me.bc.onNodeClick(me.node);me.bc.navigateTo(me.node)};me.onhover=function(e){var me=this,c=me.bc.$container[0];e.node=me.node;e.bubblePos={x:me.pos.x,y:me.pos.y};e.mousePos={x:e.origEvent.pageX-c.offsetLeft,y:e.origEvent.pageY-c.offsetTop};e.type="SHOW";e.target=me;me.bc.tooltip(e)};me.onunhover=function(e){var me=this,c=me.bc.$container[0];e.node=me.node;e.type="HIDE";e.target=me;e.bubblePos={x:me.pos.x,y:me.pos.y};e.mousePos={x:e.origEvent.pageX-c.offsetLeft,y:e.origEvent.pageY-c.offsetTop};me.bc.tooltip(e)};me.init()};